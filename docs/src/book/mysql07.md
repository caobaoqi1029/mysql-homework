---
title: MySQL 视图和触发器的使用
order: 7
icon: /mysql-item.svg
category:
  - BOOK
  - MD
---

视图是数据库中根据子模式设计的虚拟表，只存放视图定义的语句，数据存储在对应的表中，可以根据个性化需求从一张或多张表中抽取部分字段定义成视图，简化用户操作，提高数据库系统安全性。触发器是用户定义在数据表上的一类特殊存储过程，用于实现MySQL中的复杂完整性约束，不需要专门的语句调用，在数据插入、修改或删除时自动激活，防止不正确、未授权或不一致的数据操作。

## 一、视图的定义及维护

为了让不同用户只看到自己需要并有权看到的内容，MySQL提供了视图机制。视图是由一个或多个表导出的虚表，其中并不存放实际数据，只存放结构及与原数据表结构之间的关系。它可以对应一个基本表的部分元组或部分字段，这样的视图可以作为修改相关基本表中相应字段值的传送器。它也可以是对一个表使用聚合函数或表达式、分组操作、排序操作等查询操作后形成的，当调用这个视图时会自动对表执行这些操作并返回结果，其功能相当于一个查询器。它还可以是对多个表按连接查询或子查询的方式抽取部分数据形成的，这也相当于一个查询器。

### 1.1 视图的作用

视图在数据库中类似于真实表，包含一系列带有名称的列和行数据。然而，这些数据实际上存储在对应的表中，当查询视图时，数据库系统会从相应的表中检索指定的数据。因此，视图中的数据依赖于其对应表中的数据，并且在引用视图时会动态生成。一旦表中的数据发生改变，显示在视图中的数据也会相应改变。视图为不同用户提供了以不同方式访问数据的机制，让用户感觉数据库中的数据是为其量身定制的。视图中实际存储的是一段SQL查询语句，当调用视图时，该SQL查询语句会被自动执行。

使用视图的好处在于，当多个用户对数据库中的数据有相同的查询需求时，他们不必每次都重新编写复杂的SQL查询语句，而是可以直接打开视图来获取他们需要的数据。这样可以节省时间和精力，并且确保每个用户都可以方便地获取他们所需的数据。 视图的作用主要有以下几个方面：简化用户的操作、实现数据库系统的安全性、提高数据逻辑独立性。

### - 简化用户的操作

视图不仅可以简化用户对数据的理解，还可以简化用户的操作。用户在视图中看到的就是他们需要的数据。当用户需要的数据通过基本表构造比较复杂时，可以将需要的数据结构定义成视图。例如，可以将多表连接的查询定义成视图，这样复杂的表与表之间的连接操作被封装在视图中，对用户隐藏起来，使用户看到和使用的是经过连接后的虚拟表。这样可以让用户更轻松地获取他们需要的数据，而不必关心底层复杂的数据结构和连接操作。

### - 实现数据库系统的安全性

在设计数据库应用系统时，针对不同的用户可以定义不同的视图。在这些视图中，只提供该用户需要且有权查看的数据，而不提供该用户无权查看的数据。这样，不同的用户通过操作各自的视图，可以在各自的权限范围内对数据库中的数据进行使用。这种做法增强了数据的安全访问控制，确保用户只能访问他们被授权查看的数据，从而提高了数据库系统的安全性。

### - 提高数据逻辑独立性

在数据库的逻辑结构发生变化时，可以通过建立视图的方式来屏蔽这种变化，从而使得建立在数据库表上的应用程序继续提供原来的数据结构，使得应用程序不受这种变化的影响仍可以正常工作。 举例来说，假设原来有两张表 "学生" 和 "选课"，它们的结构分别如下： 学生 (学号, 姓名, 年龄, 性别, 所在班级, 籍贯) 选课 (学号, 课程号, 成绩) 现在将它们合并成一张表 "学生选课"，结构为：学生选课 (学号, 姓名, 年龄, 性别, 所在班级, 籍贯, 课程号, 成绩)。在这种情况下，可以在 "学生选课" 表上建立两个视图，视图的名字和原来的表名相同。这样，建立在原有的 "学生" 或 "选课" 表上的应用程序仍可以继续正常工作。 另一个例子是，将数据库中原来的一张表 "学生" (学号, 姓名, 年龄, 性别, 所在班级, 籍贯) 分解为两张表学生1 (学号, 姓名, 年龄, 性别) 和学生2 (学号, 所在班级, 籍贯)。在这种情况下，可以通过对两张表的多表连接查询定义成视图 "学生"，这样建立在原有的 "学生" 表上的应用程序仍可以继续正常工作。 这两个例子说明，尽管数据库的逻辑结构发生了变化，但由于视图机制，新建立的视图为应用程序提供了原来使用的表，使得数据库的外模式保持不变，原有的应用程序通过视图仍能查找到数据，从而应用程序不必修改仍可以正常工作，提高了应用程序和数据库逻辑结构的独立性。

### 1.2 视图的创建、更新和删除

### - 视图的创建

创建视图使用的基本格式如下：

```sql
CREATE VIEW <视图名> [ <字段名列表> ]
AS <子查询>
[ WITH CHECK OPTION ];
```

关于这个格式，有以下几点需要说明：

1. 表和视图共享数据库中相同的名称空间，因此视图名不能和已有的表名相同。
2. 若省略字段名列表，视图中的列名与子查询 SELECT 子句中的目标列名一致。当子查询的目标列是聚合函数、字段表达式、数据源中多个表的公共字段，或者需要在视图中使用新的列名时，必须在定义视图时指定视图中的字段名。
3. WITH CHECK OPTION 是可选项，表示在对视图进行更新操作时，必须保证更新后的数据满足子查询 WHERE 子句中的条件。

### - 视图的更新

对视图的更新实际上就是对基本表的更新，因为视图本质上是虚拟表。当对视图执行插入、修改和删除操作时，实际上是转换成对相应基本表的操作。

对于定义时带了 WITH CHECK OPTION 选项的视图，插入和修改操作必须保证数据满足子查询 WHERE 子句的条件。这意味着插入或修改的数据必须符合视图定义中所指定的条件，否则操作将被拒绝。这样可以确保视图的数据始终符合特定的条件，从而保持数据的一致性和完整性。

### - 视图的删除

使用 `DROP VIEW` 语句来删除视图，其基本格式如下：

```sql
DROP VIEW 视图名;
```

当视图被删除后，视图的定义将从数据字典中删除，但是视图的数据仍然保存在对应的基本表中。这意味着删除视图不会影响基本表中的数据，只是删除了对这些数据的虚拟展示。

### 1.3 从视图中查询数据

视图可以像基本表一样作为 SELECT 语句的数据源。当从视图中查找数据时，实际上是从对应的基本表中进行查找。这意味着使用视图可以简化复杂查询的编写，提供了一种逻辑上的数据抽象，使得用户可以方便地访问和操作数据，而无需了解底层表结构的复杂性。

## 二、 触发器的使用

触发器是与 MySQL 数据表有关的数据库对象，它是一种特殊的存储过程。当满足触发器定义的条件时，触发器会被触发，并执行其中定义的语句集合。触发器的这种特性可以应用在数据库端，确保数据的完整性。

触发器可以用于实现复杂的数据完整性约束和业务规则等。例如，可以使用触发器来实现级联更新、级联删除、限制插入或修改的数据范围等功能。触发器的执行不是由程序调用，而是由事件来触发，例如对一个表进行操作（如插入、删除、更新）时就会激活相应的触发器。这种特性使得触发器可以在数据库端自动执行一些操作，从而保证数据的完整性和一致性。

### 2.1 触发器的功能和类型

触发器是一种特殊的存储过程，是提供给程序员和数据分析员来保证数据完整性的一种方法。触发器是与表事件相关的，当对一个表进行操作（如插入、删除、更新）时就会激活相应的触发器，它的执行不是由程序调用，而是由事件来触发。

触发器经常用于加强数据的完整性约束和业务规则等。触发器创建语法包括四个要素：

1. 触发地点（table）：指定触发器对哪个表起作用。
2. 触发事件（insert/update/delete）：指定在对表执行什么操作时触发触发器。
3. 触发时间（before/after）：指定在表执行相应操作前还是操作后触发触发器。
4. 触发器程序体（begin/end）：指定触发后执行的动作。

触发器可以实现复杂的数据完整性约束和业务规则等，例如级联更新、级联删除、限制插入或修改的数据范围等。触发器的执行可以在数据库端自动执行一些操作，从而保证数据的完整性和一致性。

### 2.2 创建和使用触发器

创建触发器使用 CREATE TRIGGER 语句，其基本格式如下：

```sql
CREATE TRIGGER <触发器名> <BEFORE | AFTER>
<INSERT | UPDATE | DELETE>
ON <表名> FOR EACH ROW
```



这个语句的各部分含义如下：
- CREATE TRIGGER：表示创建触发器的语句。
- `<触发器名>`：指定触发器的名称，触发器在当前数据库中必须具有唯一的名称。
- `<BEFORE | AFTER>`：指定触发器是在触发事件之前还是之后执行。
- `<INSERT | UPDATE | DELETE>`：指定触发事件，即在对表执行何种操作时触发触发器。
- `ON <表名>`：指定触发器对哪个表起作用。
- FOR EACH ROW：表示每当受影响的表的每一行发生变化时都会触发触发器。

通过这个语句，可以创建满足特定条件时触发的触发器，以执行相应的操作来维护数据的完整性和一致性。

- 触发器名：指定触发器的名称，触发器在当前数据库中必须具有唯一的名称。如果要在某个特定数据库中创建，名称前面应该加上数据库的名称。
- INSERT/UPDATE/DELETE：这三个关键字用于指定触发事件，即在对表执行何种操作时触发触发器。INSERT表示将新行插入表时激活触发器，DELETE表示从表中删除某一行数据时激活触发器，UPDATE表示更改表中某一行数据时激活触发器。
- BEFORE/AFTER：BEFORE和AFTER指触发器被触发的时刻，表示触发器是在激活它的语句之前或之后触发。如果希望验证新数据是否满足条件，则使用BEFORE选项；如果希望在激活触发器的语句执行之后完成几个或更多的改变，则通常使用AFTER选项。
- 表名：与触发器相关联的表名，此表必须是永久性表，不能将触发器与临时表或视图关联起来。在该表上触发事件发生时才会激活触发器。
- 触发器主体：触发器动作主体，包含触发器激活时将要执行的MySQL语句。如果要执行多个语句，可以使用BEGIN/END复合语句结构。

总之，触发器是一种与MySQL数据表有关的数据库对象，可以在满足定义条件时触发，并执行触发器中定义的语句集合，用于加强数据的完整性约束和业务规则等。创建触发器使用CREATE TRIGGER语句，可以指定触发器的名称、触发事件、触发时刻、相关联的表名和触发器主体等信息。

### 2.3 利用触发器实现数据完整性约束

这段文字解释了触发器在MySQL中的应用，可以实现复杂的数据完整性约束，比如对一个表执行插入、修改或删除时，需要级联更新另一个表中相关记录的指定字段值。在MySQL中，由于不支持CHECK约束，还需要用触发器来实现CHECK约束的功能。同时，MySQL中的触发器不能使用显示或隐式方式开始或结束事务的语句，如START TRANSACTION、COMMIT或ROLLBACK，因此要实现回滚事务的操作，只能利用OLD或NEW关键字来访问受触发器影响的行中的列。在INSERT型触发器中，仅能使用NEW；在DELETE型触发器中，仅能使用OLD；在UPDATE型触发器中，既能使用NEW也能使用OLD。

### 2.4 查看和删除触发器

